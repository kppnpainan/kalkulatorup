<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>KPPN Painan - Hitung UP</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100">
  <div class="max-w-md mx-auto bg-white shadow-lg rounded-lg p-4 mt-6">
    <div class="bg-purple-300 text-blue-700 text-center text-2xl font-bold py-3 rounded">KPPN Painan</div>

    <div class="flex justify-between items-center mt-2">
      <h2 class="text-left text-xl font-bold text-gray-700">Hitung UP</h2>
      <h2 id="hasil" class="text-right text-2xl font-bold"></h2>
    </div>

    <label class="block mt-3 font-medium" for="kode_satker">Kode Satker</label>
    <input type="text" id="kode_satker" class="w-full border p-2 rounded bg-blue-100">

    <label class="block mt-3 font-medium" for="nomor_spp">Nomor SPP</label>
    <input type="text" id="nomor_spp" class="w-full border p-2 rounded bg-green-100">

    <label class="block mt-3 font-medium" for="up">Jumlah Uang Persediaan (UP)</label>
    <input type="text" id="up" class="w-full border p-2 rounded text-right" oninput="formatNumber(this)">

    <label class="block mt-3 font-medium" for="gup">Jumlah GUP yang akan diajukan</label>
    <input type="text" id="gup" class="w-full border p-2 rounded text-right" oninput="formatNumber(this)">

    <label class="block mt-3 font-medium" for="tgl_pengajuan">Pengajuan Sebelumnya</label>
    <input type="date" id="tgl_pengajuan" class="w-full border p-2 rounded" onchange="hitungHariGUP()">

    <label class="block mt-3 font-medium" for="tgl_hari_ini">Rencana Pengajuan Sekarang</label>
    <input type="date" id="tgl_hari_ini" class="w-full border p-2 rounded" onchange="hitungHariGUP()">

    <input type="hidden" id="hari_sebulan">
    <input type="hidden" id="hari_gup">

    <button id="btnHitung" class="w-full bg-green-500 text-white py-2 mt-5 rounded-lg hover:bg-green-700" onclick="hitungHasil()">Hitung</button>
  </div>

<script>
  // Ganti dengan URL web app Apps Script (akhiri dengan /exec)
  const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwNpVE_QFwlyf7xCwpY_bM-0ha_Sy4fwgqsosutUEtCDRyLIzDjsG4LpPDyrJJtN0oO/exec";

  function formatNumber(input) {
    let value = input.value.replace(/[^\d]/g, "");
    if (value === "") { input.value = ""; return; }
    input.value = Number(value).toLocaleString("id-ID");
  }

  function hitungHariGUP() {
    let tglPengajuan = new Date(document.getElementById("tgl_pengajuan").value);
    let tglHariIni = new Date(document.getElementById("tgl_hari_ini").value);

    if (!isNaN(tglPengajuan)) {
      let year = tglPengajuan.getFullYear();
      let month = tglPengajuan.getMonth() + 1;
      let daysInMonth = new Date(year, month, 0).getDate();
      document.getElementById("hari_sebulan").value = daysInMonth;
    }

    if (!isNaN(tglPengajuan) && !isNaN(tglHariIni)) {
      let hariGup = Math.floor((tglHariIni - tglPengajuan) / (1000 * 60 * 60 * 24));
      document.getElementById("hari_gup").value = hariGup;
    }
  }

  function hitungHasil() {
    let up = parseFloat(document.getElementById("up").value.replace(/[^\d]/g, "")) || 0;
    let gup = parseFloat(document.getElementById("gup").value.replace(/[^\d]/g, "")) || 0;
    let hariSebulan = parseFloat(document.getElementById("hari_sebulan").value) || 0;
    let hariGup = parseFloat(document.getElementById("hari_gup").value) || 0;

    if (up === 0 || gup === 0 || hariSebulan === 0 || hariGup <= 0) {
      document.getElementById("hasil").innerText = "Isi semua nilai!";
      document.getElementById("hasil").className = "text-red-500 text-2xl font-bold";
      return;
    }

    if (gup < 0.5 * up) {
      alert("GUP tidak boleh kurang dari 50% dari UP.");
      return;
    }
    if (gup > up) {
      alert("GUP tidak boleh lebih besar dari UP.");
      return;
    }

    let hasil = ((gup / up) * (hariSebulan / hariGup)) * 100;
    let hasilText = hasil.toFixed(2) + "%";
    document.getElementById("hasil").innerText = hasilText;
    document.getElementById("hasil").className = hasil >= 100 ? "text-green-500 text-2xl font-bold" : "text-red-500 text-2xl font-bold";

    simpanData(hasilText);
  }

  function simpanData(hasil) {
    const form = new FormData();
    form.append("kode_satker", document.getElementById("kode_satker").value || "");
    form.append("nomor_spp", document.getElementById("nomor_spp").value || "");
    form.append("up", document.getElementById("up").value || "");
    form.append("gup", document.getElementById("gup").value || "");
    form.append("tgl_pengajuan", document.getElementById("tgl_pengajuan").value || "");
    form.append("tgl_sekarang", document.getElementById("tgl_hari_ini").value || "");
    form.append("hasil_persen", hasil || "");

    console.log("Kirim FormData ke:", SCRIPT_URL);

    fetch(SCRIPT_URL, {
      method: "POST",
      body: form // <-- jangan set Content-Type; biarkan browser buat boundary
    })
    .then(async res => {
      console.log("HTTP status:", res.status);
      const text = await res.text();
      console.log("Respon server:", text);
      try {
        const json = JSON.parse(text);
        if (json.status === "success") {
          alert("Data berhasil disimpan.");
        } else {
          alert("Server balas error: " + (json.message || text));
        }
      } catch (e) {
        // kalau bukan JSON, tampilkan apa adanya
        alert("Respon server: " + text);
      }
    });
  }
</script>
</body>
</html>
